---
version: "3.7"
# Services:
  # Traefik
  # Nextcloud
  # Rancher?
  # Jenkins
  # Blog
  # Mayan
  # Email server
  # LibreOffice Online / Collabora
  # PiHole or other DNS
  # Snort or other IDS
  # Joplin
  # Searx https://github.com/linuxserver/Heimdall/issues/307
  # PrivateBin
  # Syncthing?
  # EteSync?
  # Bitwarden?
  # Mining operation?
  # Squid Proxy? Shadowsocks? Or other proxy
  # IRC
  # TOR Node, hidden service
  # i2p
  # KVM?
  # LDAP?
# Organization
  # TODO: Apply consistent port assignment scheme.
  # TODO: Segregate services into subnetworks.
  # TODO: Make some services run on the host (performance, true IP visibility)
services:

  letsencrypt:
    image: linuxserver/letsencrypt
    container_name: letsencrypt
    cap_add:
      - NET_ADMIN
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - URL=maxocull.net
      - SUBDOMAINS=www,resolute,whoami,dash,cloud,git
      - VALIDATION=http # DNS? so can use wildcards
      #- DNSPLUGIN=cloudflare #optional
      #- DUCKDNSTOKEN=<token> #optional
      - EMAIL=max.ocull@protonmail.com
      - DHLEVEL=2048
      - ONLY_SUBDOMAINS=false
      #- EXTRA_DOMAINS=<extradomains> #optional
      - STAGING=true # TODO: Disable when done testing.
    volumes:
      - /opt/flotilla/data/letsencrypt/keys:/config/etc/letsencrypt:Z
      - /opt/flotilla/data/letsencrypt/www:/config/www:Z
      - /opt/flotilla/config/letsencrypt:/config:z
      - /opt/flotilla/data/all/logs/letsencrypt:/config/log:Z
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped

  dockersocket:
    # Limits access to the docker socket which is dangerous to expose to
    # containers which see the internet; compromise of these external facing
    # containers could mean granting root access to the entire host (and all
    # other containers).
    image: tecnativa/docker-socket-proxy
    container_name: dockersocket
    privileged: true # Necessary for docker access.
    ports:
      # TODO: Reduce this to 127.0.01:2375:2375.
      - "2375:2375"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - LOG_LEVEL=debug # info
      #- EVENTS=1
      #- PING=1
      #- VERSION=1
      - AUTH=0 # Security critical
      - SECRETS=0 # Security critical
      - POST=0 # Security critical
      #- BUILD=1
      #- COMMIT=1
      #- CONFIGS=1
      - CONTAINERS=1 # For Traefik
      #- DISTRIBUTION=1
      #- EXEC=1
      #- IMAGES=1
      #- INFO=1
      - NETWORKS=1 # For Traefik
      #- NODES=1
      #- PLUGINS=1
      - SERVICES=1 # For Traefik
      #- SESSION=1
      #- SWARM=1
      #- SYSTEM=1
      #- VOLUMES=1
      - TASKS=1 # For Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - 'traefik.enable=false'
    restart: unless-stopped

  traefik:
    # Reverse proxy with auto-routing capabilities. Aimed at HTTP/S but works
    # with TCP too.
    image: traefik
    container_name: traefik
    command:
      #- "--configFile=/etc/traefik/traefik.toml"
      - "--api.insecure=true" # TODO: Change this back.
      - "--ping"
      - "--providers.docker=true"
      - "--providers.docker.endpoint=tcp://dockersocket:2375"
      - "--providers.docker.defaultRule=Host(`{{ normalize .Name }}.maxocull.net`)"
      - "--providers.docker.exposedByDefault=true"
      - "--providers.docker.useBindPortIp=false"
      #- "--log.filePath=/var/log/traefik.log"
      - "--log.level=DEBUG"
      - "--accessLog.filePath=/var/log/access.log"
      - "--metrics.prometheus"
      - "--global.sendAnonymousUsage=false"
      - "--global.checkNewVersion=true"
      - "--entrypoints.http.address=:80"
      - "--entrypoints.https.address=:443"
      - "--entrypoints.traefik.address=:8080"
      - "--certificatesResolvers.le-main.acme.email=max.ocull@protonmail.com"
      - "--certificatesResolvers.le-main.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory" # Staging server for testing.
      #- "--certificatesResolvers.le-main.acme.storage=/var/acme/acme.json"
      - "--certificatesResolvers.le-main.acme.tlsChallenge=true"
      #- "--certificatesResolvers.le-main.acme.httpChallenge=true"
      #- "--certificatesResolvers.le-main.acme.httpChallenge.entryPoint=http"
    ports:
      - "80:80"
      - "8080:8080"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      #- DOCKER_HOST=tcp://dockersocket
    volumes:
      - /opt/flotilla/data/traefik:/var/acme:z
      - /opt/flotilla/config/traefik:/etc/traefik:z
      - /opt/flotilla/data/all/logs/traefik:/var/log:Z
    restart: unless-stopped

  whoami:
    image: containous/whoami
    container_name: whoami
    ports:
      - "8001:80"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      ##- DOCKER_HOST=tcp://dockersocket
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.http-whoami.rule=Host(`whoami.maxocull.net`)"
      - "traefik.http.routers.http-whoami.entryPoints=http"
      - "traefik.http.routers.https-whoami.rule=Host(`whoami.maxocull.net`)"
      - "traefik.http.routers.https-whoami.entryPoints=https"
      - "traefik.http.routers.https-whoami.tls=true"
      - "traefik.http.routers.https-whoami.tls.certResolver=le-main"
      #- "traefik.http.routers.https-whoami.tls.domains[0].main=whoami.maxocull.net"

  #watchtower:
    ## TODO: Not recommended by LinuxServer.io
    #image: containrrr/watchtower
    #container_name: watchtower
    #environment:
      #- PUID=1000
      #- PGID=1000
      #- TZ=America/Indianapolis
      #- WATCHTOWER_CLEANUP=true
      ##- WATCHTOWER_SCHEDULE='0 0 4 * * *' # Every night at 04:00.
      ## TODO: Email notifications (requires SMTP).
      ## https://containrrr.github.io/watchtower/notifications/
    #volumes:
      #- /var/run/docker.sock:/var/run/docker.sock
      ##- /opt/flotilla/config/watchtower/config.json:/config.json:z
    #restart: unless-stopped

  pihole:
    image: pihole/pihole
    container_name: pihole
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "1188:80/tcp"
      - "1443:443/tcp"
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - DNSSEC=True
    volumes:
      - /opt/flotilla/config/pihole/pihole:/etc/pihole:z
      - /opt/flotilla/config/pihole/dnsmasq:/etc/dnsmasq.d:z
    dns:
      - 127.0.0.1
      # DNS.WATCH servers, with DNSSEC enabled.
      - 84.200.69.80
      - 84.200.70.40
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
    #labels:
      #- "traefik.enable=true"
      #- "traefik.backend=pihole"
      #- "traefik.port=80"
      #- "traefik.frontend.rule=HostRegexp:dns.maxocull.com,{catchall:.*}"
      #- "traefik.frontend.priority=1"
      #- traefik.frontend.headers.SSLRedirect=true
      #- traefik.frontend.headers.STSSeconds=315360000
      #- traefik.frontend.headers.browserXSSFilter=true
      #- traefik.frontend.headers.contentTypeNosniff=true
      #- traefik.frontend.headers.forceSTSHeader=true
      #- traefik.frontend.headers.SSLHost=maxocull.com
      #- traefik.frontend.headers.STSIncludeSubdomains=true
      #- traefik.frontend.headers.STSPreload=true
      #- traefik.frontend.headers.frameDeny=true

  openvpn:
    image: kylemanna/openvpn
    container_name: openvpn
    #privileged: true # Necessary for sysctl net settings.
    # TODO: Test that these work.
    sysctls:
      - "net.ipv4.ip_forward: 1"
      - "net.ipv6.conf.all.disable_ipv6: 0"
      - "net.ipv6.conf.default.forwarding: 1"
      - "net.ipv6.conf.all.forwarding: 1"
    cap_add:
      - NET_ADMIN
    volumes:
      - /opt/flotilla/config/openvpn:/etc/openvpn:z
    environment:
      - EASYRSA_KEY_SIZE=4096
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    ports:
      - "1194:1194/udp"
    restart: unless-stopped

  jackett:
    image: linuxserver/jackett
    container_name: jackett
    depends_on:
      - cleanroom
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - RUN_OPTS="--ProxyConnection=cleanroom:8118"
    volumes:
      - /opt/flotilla/config/jackett:/config:z
      - /opt/flotilla/data/all/torrents:/downloads:Z
    ports:
      - "9117:9117"
    restart: unless-stopped

  cleanroom:
    image: binhex/arch-qbittorrentvpn
    container_name: cleanroom
    privileged: true # Necessary for iptables killswitch.
    cap_add:
      - NET_ADMIN
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - WEBUI_PORT=8800
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - UMASK=000
      - DEBUG=false
      - NAME_SERVERS=128.52.130.209,169.239.202.202,84.200.69.80,84.200.70.40,91.239.100.100,89.233.43.71,37.235.1.174,37.235.1.177,1.1.1.1,1.0.0.1
      - LAN_NETWORK=192.168.0.0/16
      - ENABLE_PRIVOXY=yes
      - VPN_ENABLED=yes
      - VPN_PROV=nordvpn # This is a custom VPN.
    volumes:
      - /opt/flotilla/config/cleanroom:/config:z
      - /opt/flotilla/data/all/torrents:/torrents:Z
      - /opt/flotilla/data/cleanroom:/data:Z
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "6881:6881"
      - "6881:6881/udp"
      - "8800:8800" # Change the WEBUI_PORT environment variable as well!
      - "8118:8118" # Change the proxy port for Jackett as well!
    restart: unless-stopped

  sonarr:
    image: linuxserver/sonarr
    container_name: sonarr
    depends_on:
      - cleanroom
      - jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - UMASK=022
    volumes:
      - /opt/flotilla/config/sonarr:/config:z
      - /opt/flotilla/data/all/tvshows:/tv:Z
      - /opt/flotilla/data/cleanroom:/data:Z
    ports:
      - "8989:8989"
    restart: unless-stopped

  radarr:
    image: linuxserver/radarr
    container_name: radarr
    depends_on:
      - cleanroom
      - jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - UMASK=022
    volumes:
      - /opt/flotilla/config/radarr:/config:z
      - /opt/flotilla/data/all/movies:/movies:Z
      - /opt/flotilla/data/cleanroom:/data:Z
    ports:
      - "7878:7878"
    restart: unless-stopped

  lidarr:
    image: linuxserver/lidarr
    container_name: lidarr
    depends_on:
      - cleanroom
      - jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - UMASK=022
    volumes:
      - /opt/flotilla/config/lidarr:/config:z
      - /opt/flotilla/data/all/music:/music:Z
      - /opt/flotilla/data/cleanroom:/data:Z
    ports:
      - "8686:8686"
    restart: unless-stopped

  jellyfin:
    image: linuxserver/jellyfin
    container_name: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - UMASK_SET=<022> #optional
    volumes:
      - /opt/flotilla/config/jellyfin:/config:z
      - /opt/flotilla/data/all/tvshows:/data/tvshows:Z
      - /opt/flotilla/data/all/movies:/data/movies:Z
      - /opt/flotilla/data/all/music:/data/music:Z
      - /opt/flotilla/data/all/books:/data/books:Z
      - /opt/flotilla/data/all/photos:/data/photos:Z
      - /opt/flotilla/data/jellyfin/transcode:/transcode:Z #optional
    ports:
      - "8096:8096"
      #- "8920:8920" #optional, https
    devices:
      - /dev/dri:/dev/dri #optional, for video HW acceleration
    restart: unless-stopped

  postgres:
    image: postgres
    container_name: postgres
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      #- POSTGRES_USER=harbor # Use the default "postgres" user.
    ports:
      - "5432:5432"
    volumes:
      - /opt/flotilla/data/postgres:/var/lib/postgresql/data:z
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    env_file:
      - /opt/flotilla/secrets.env
    depends_on:
      - postgres
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      # The email below _is_ the username.
      - PGADMIN_DEFAULT_EMAIL=postgres@maxocull.com
    ports:
      - "5480:80"
    volumes:
      #- /opt/flotilla/config/pgadmin:/pgadmin4:z
      - /opt/flotilla/data/pgadmin:/var/lib/pgadmin:z
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=PathPrefix(`/pgadmin`)"
      - "traefik.http.routers.pgadmin.entryPoints=http"
      - "traefik.http.middlewares.strip-pgadmin.stripPrefix.prefixes=pgadmin"
      - "traefik.http.routers.pgadmin.middlewares=strip-pgadmin"

  redis:
    # TODO: Resolve some kernel settings to clear up the logs.
    image: redis
    container_name: redis
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    ports:
      - "6379:6379"
    volumes:
      - /opt/flotilla/data/redis:/data:z # Remove this line if not persistent.
    restart: unless-stopped

  nextcloud:
    # Switch to FPM after reverse proxy is set up.
    image: nextcloud
    container_name: nextcloud
    depends_on:
      - redis
      - postgres
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_HOST=postgres
      - NEXTCLOUD_ADMIN_USER=entourage
      - REDIS_HOST=redis
      #- SMTP_HOST=
      #- SMTP_SECURE=ssl
      #- SMTP_PORT=465
      #- SMTP_NAME=nextcloud
      #- MAIL_FROM_ADDRESS=nextcloud
      #- MAIL_DOMAIN=mail.maxocull.com
    volumes:
      - /opt/flotilla/config/nextcloud:/var/www/html/config:z
      - /opt/flotilla/data/nextcloud:/var/www/html:Z
    ports:
      - "3080:80"
      #- "3090:9000" # for FPM
    restart: unless-stopped

  gitlab:
    image: sameersbn/gitlab
    container_name: gitlab
    env_file:
      - /opt/flotilla/secrets.env
    depends_on:
      - postgres
      - redis
      - postfix
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - DB_HOST=postgres
      - DB_NAME=gitlabhq_production
      - DB_USER=gitlab
      - DB_EXTENSION=pg_trgm
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SMTP_ENABLED=false # Flip on after the mail server is setup.
      - IMAP_ENABLED=false # Flip on after the mail server is setup.
      - IMAP_USER=gitlab@maxocull.com
      - IMAP_DOMAIN=www.maxocull.com
      - IMAP_HOST=mail.maxocull.com
      - IMAP_PORT=993
      #- PIWIK_URL=
      #- PIWIK_SITE_ID=
    depends_on:
      - redis
      - postgres
    volumes:
      - /opt/flotilla/data/gitlab:/home/git/data:z
    ports:
      # Keep this as a string because I guess docker-compose (Python) has a bug?
      - "4080:80"
      - "4022:22"
    restart: unless-stopped

  #jenkins:
    # TODO: Opt for Gitlab CI?
    #image: jenkins/jenkins:lts
    #container_name: jenkins
    #environment:
      #- PUID=1000
      #- PGID=1000
      #- TZ=America/Indianapolis
    #volumes:
      #- /opt/flotilla/data/jenkins:/var/jenkins_home:z
      #- /var/run/docker.sock:/var/run/docker.sock # Behind a reverse proxy, it's okay.
    #ports:
      #- "7080:8080"
      #- "50000:50000"
    #restart: unless-stopped

  postfix:
    image: mailu/postfix
    container_name: postfix
    env_file:
      - /opt/flotilla/mailu.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /opt/flotilla/data/postfix:/data:z
      - /opt/flotilla/config/postfix:/overrides:z
    ports:
      - "25:25"
      - "10025:10025"

  heimdall:
    image: linuxserver/heimdall
    container_name: heimdall
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /opt/flotilla/config/heimdall:/config:z
    ports:
      - "1080:80"
      - "1443:443"
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.http-dash.rule=Host(`dash.maxocull.net`)"
      - "traefik.http.routers.http-dash.entryPoints=http"
      - "traefik.http.routers.https-dash.rule=Host(`dash.maxocull.net`)"
      - "traefik.http.routers.https-dash.entryPoints=https"
      - "traefik.http.routers.https-dash.tls=true"
      - "traefik.http.routers.https-dash.tls.certResolver=le-main"
      #- "traefik.http.routers.https-dash.tls.domains[0].main=dash.maxocull.net"

  grafana:
    image: grafana/grafana
    container_name: grafana
    user: "1000"
    env_file:
      - /opt/flotilla/secrets.env
    depends_on:
      - prometheus
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - "GF_SECURITY_ADMIN_USER=entourage"
      - "GF_SERVER_DOMAIN=grafana.maxocull.net"
      - "GF_SERVER_ROOT_URL=https://grafana.maxocull.net"
      - "GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-worldmap-panel,grafana-pie-chart-panel"
    volumes:
      - /opt/flotilla/config/grafana:/etc/grafana:z
      - /opt/flotilla/data/grafana/data:/var/lib/grafana:z
      #- /opt/flotilla/data/grafana/home:/usr/share/grafana:z
      - /opt/flotilla/data/grafana/logs:/var/log/grafana:z
    ports:
      - "3000:3000"
    restart: unless-stopped

  loki:
    image: grafana/loki
    container_name: loki
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    ports:
      - "3100:3100"
    #command:
      #- '--config.file=/etc/loki/local-config.yml'
    restart: unless-stopped

  promtail:
    image: grafana/promtail
    container_name: promtail
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /opt/flotilla/data/all/logs:/var/log:Z
    #command:
      #- '--config.file=/etc/promtail/docker-config.yml'
    restart: unless-stopped

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    user: "1000"
    depends_on:
      - nodeexporter
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /opt/flotilla/config/prometheus:/etc/prometheus:z
      - /opt/flotilla/data/prometheus:/prometheus:z
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9095:9090" # conflicts with Fedora's Cockpit at 9090
    restart: unless-stopped

  nodeexporter:
    image: quay.io/prometheus/node-exporter
    container_name: nodeexporter
    cap_add:
      - SYS_TIME
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /:/host:ro,rslave
    command:
      - '--path.rootfs=/host'
    ports:
      - "9100:9100"
    restart: unless-stopped

  portainer:
    image: portainer/portainer
    container_name: portainer
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Behind a reverse proxy, it's okay.
      - /opt/flotilla/data/portainer:/data:z
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped

  #nginx:
    #image: linuxserver/nginx
    #container_name: nginx
    #environment:
      #- PUID=1000
      #- PGID=1000
      #- TZ=America/Indianapolis
      #- URL=maxocull.com
      #- SUBDOMAINS=www,cdn,cloud,alan
      #- VALIDATION=http # DNS? so can use wildcards
      ##- DNSPLUGIN=cloudflare #optional
      ##- DUCKDNSTOKEN=<token> #optional
      #- EMAIL=max.ocull@protonmail.com #optional
      #- DHLEVEL=4096 #optional
      #- ONLY_SUBDOMAINS=false #optional
      ##- EXTRA_DOMAINS=<extradomains> #optional
      #- STAGING=false
    #volumes:
      #- /opt/flotilla/config/nginx:/config:z
      #- /opt/flotilla/data/all/logs/nginx:/config/log:Z
    #ports:
      #- "80:80"
      #- "443:443"
    #restart: unless-stopped

  morty:
    image: dalf/morty
    container_name: morty
    cap_drop:
      - ALL
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
    ports:
      - "4040:3000"
    restart: unless-stopped

  searx:
    image: searx/searx
    container_name: searx
    privileged: true # Necessary for docker access.
    cap_drop:
      - ALL
    cap_drop:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    depends_on:
      - morty
    env_file:
      - /opt/flotilla/secrets.env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Indianapolis
      - BASE_URL=https://search.maxocull.net/
      - MORTY_URL=http://morty/
    volumes:
      - /opt/flotilla/config/searx:/etc/searx:z
    ports:
      - "4050:8080"
    restart: unless-stopped
